<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Trialing Records Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(90deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .last-updated {
            opacity: 0.8;
            font-size: 0.95rem;
            font-style: italic;
        }

        .logo {
            width: 160px;
            height: 160px;
            background-image: url('https://raw.githubusercontent.com/cwagtracker/Tracker/main/cwags-logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .owner-view-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .owner-view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .main-content {
            padding: 30px;
        }

        .summary-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
        }

        .section-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-content {
            padding: 20px;
        }

        .dog-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .dog-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .dog-info p {
            color: #7f8c8d;
            margin: 5px 0;
        }

        .handler-name {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .level-summary {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }

        .level-info {
            flex: 1;
        }

        .level-summary h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-status {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .title-earned {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .no-title {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .points-breakdown {
            font-size: 0.9rem;
            margin: 8px 0;
        }

        .points-breakdown div {
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
        }

        .ace-info {
            color: #6f42c1;
            font-weight: 600;
        }

        .details-btn {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            align-self: start;
        }

        .details-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .validation-rules {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .validation-rules h4 {
            color: #004085;
            margin-bottom: 10px;
        }

        .validation-rules ul {
            margin-left: 20px;
        }

        .validation-rules li {
            color: #004085;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .upload-section {
            text-align: center;
            padding: 40px;
        }

        .upload-area {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
            margin: 20px 0;
        }

        .upload-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
        }

        .retry-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .records-table th,
        .records-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        .records-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .points-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .points-badge.zero {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div id="leftLogo" class="logo"></div>
                <div class="header-text">
                    <h1>CWAGS Tracker</h1>
                    <p>Track your dog's trialing progress, points, and title eligibility</p>
                    <div class="last-updated" id="lastUpdated">Ready to load data...</div>
                </div>
                <div id="rightLogo" class="logo"></div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="Enter Registration Number (e.g., 17-1734-06)" 
                       onkeypress="handleKeyPress(event)">
                <button class="search-btn" onclick="searchDog()">Search Dog Records</button>
                <button class="owner-view-btn" onclick="showOwnerView()">Owner View by ID</button>
            </div>
        </div>

        <div class="main-content">
            <div class="summary-section">
                <div class="section-header">Points Summary & Title Progress</div>
                <div class="section-content" id="summaryContent">
                    <div class="upload-section">
                        <h3 style="color: #17a2b8; margin-bottom: 20px;">📁 Upload Data File</h3>
                        <p style="margin-bottom: 20px;">Select your Excel file to load the trialing data:</p>
                        
                        <div class="upload-area">
                            <input type="file" id="dataFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 15px;">
                            <br>
                            <button class="upload-btn" onclick="loadFile()">
                                📤 Load File
                            </button>
                        </div>
                        
                        <button class="retry-btn" onclick="tryAutoLoad()">
                            🔄 Try Auto-Loading From Server
                        </button>
                    </div>
                    
                    <div class="validation-rules">
                        <h4>Title Requirements</h4>
                        <ul>
                            <li>Minimum 4 points required for each level</li>
                            <li>Points must come from at least 2 different judges</li>
                            <li>Prerequisites must be met before advancing to higher levels</li>
                            <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                            <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                            <li>Ace awards given every 10 points after title is earned</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for showing detailed records -->
        <div id="detailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Level Details</h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let trialingData = [];
        let currentDogRecords = [];
        let dogInfoData = {};
        let isDataLoaded = false;
        
        // Level prerequisites mapping
        const prerequisites = {
            "Investigator 3": ["Patrol 1", "Detective 2"],
            "Super Sleuth 4": ["Investigator 3"],
            "Private Inv": ["Super Sleuth 4"],
            "Det Diversions": ["Super Sleuth 4"],
            "Ranger 2": ["Ranger 1"],
            "Ranger 3": ["Ranger 2"],
            "Ranger 4": ["Ranger 3"],
            "Ranger 5": ["Ranger 4"],
            "Dasher 4": ["Dasher 3"],
            "Dasher 5": ["Dasher 4"],
            "Dasher 6": ["Dasher 5"],
            "Obedience 4": ["Obedience 3"],
            "Obedience 5": ["Obedience 4"]
        };

        // Official title abbreviations
        const titleAbbreviations = {
            "Patrol 1": "CW-SP",
            "Detective 2": "CW-SD",
            "Investigator 3": "CW-SI",
            "Super Sleuth 4": "CW-SS",
            "Private Inv": "CW-SPI",
            "Det Diversions": "CW-SDD",
            "Ranger 1": "CW-ScR1",
            "Ranger 2": "CW-ScR2",
            "Ranger 3": "CW-ScR3",
            "Ranger 4": "CW-ScR4",
            "Ranger 5": "CW-ScR5",
            "Dasher 3": "CW-SD3",
            "Dasher 4": "CW-SD4",
            "Dasher 5": "CW-SD5",
            "Dasher 6": "CW-SD6",
            "Obedience 1": "CW-Ob1",
            "Obedience 2": "CW-Ob2",
            "Obedience 3": "CW-Ob3",
            "Obedience 4": "CW-Ob4",
            "Obedience 5": "CW-Ob5",
            "Starter": "CW-SR",
            "Advanced": "CW-AR",
            "Pro": "CW-PR",
            "ARF": "CW-ARF",
            "Zoom 1": "CW-ZR1",
            "Zoom 1.5": "CW-ZR1.5",
            "Zoom 2": "CW-ZR2",
            "Games 1": "CW-G1",
            "Games 2": "CW-G2",
            "Games 3": "CW-G3",
            "Games 4": "CW-G4"
        };

        // Proper level ordering
        const levelOrder = [
            "Patrol 1", "Detective 2", "Investigator 3", "Super Sleuth 4", "Private Inv", "Det Diversions",
            "Ranger 1", "Ranger 2", "Ranger 3", "Ranger 4", "Ranger 5",
            "Dasher 3", "Dasher 4", "Dasher 5", "Dasher 6",
            "Obedience 1", "Obedience 2", "Obedience 3", "Obedience 4", "Obedience 5",
            "Starter", "Advanced", "Pro", "ARF",
            "Zoom 1", "Zoom 1.5", "Zoom 2",
            "Games 1", "Games 2", "Games 3", "Games 4"
        ];

        function escapeHtml(text) {
            if (!text) return '';
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function escapeJs(text) {
            if (!text) return '';
            return text.toString()
                .replace(/\\/g, "\\\\")
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, "\\n")
                .replace(/\r/g, "\\r");
        }

        // Try to auto-load data from server
        function tryAutoLoad() {
            document.getElementById('lastUpdated').textContent = 'Trying to load from server...';
            
            // Set a shorter timeout
            const timeoutId = setTimeout(() => {
                console.log('Auto-load timeout - server file not available');
                document.getElementById('lastUpdated').textContent = 'Server file not available - please upload manually';
            }, 5000);

            fetch('Data for Tracker web.xlsx', {
                method: 'GET',
                cache: 'no-cache'
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    processExcelData(new Uint8Array(data));
                    updateLastUpdatedDate();
                    showSuccessMessage();
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Auto-load failed:', error);
                    document.getElementById('lastUpdated').textContent = 'Auto-load failed - please upload file manually';
                });
        }

        function loadFile() {
            const fileInput = document.getElementById('dataFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file first');
                return;
            }

            document.getElementById('lastUpdated').textContent = 'Loading file...';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    processExcelData(data);
                    updateLastUpdatedDate();
                    showSuccessMessage();
                } catch (error) {
                    console.error('Error loading file:', error);
                    alert(`Error loading file: ${error.message}`);
                    document.getElementById('lastUpdated').textContent = 'File load failed';
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
                document.getElementById('lastUpdated').textContent = 'File read error';
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            
            // Look for Data sheet
            const dataSheet = workbook.Sheets['Data'] || workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(dataSheet, {header: 1, dateNF: 'yyyy-mm-dd'});
            
            // Process the data with proper date handling
            trialingData = jsonData.slice(1).map(row => {
                let processedDate = row[2];
                
                // Handle different date formats
                if (typeof processedDate === 'number') {
                    processedDate = XLSX.SSF.parse_date_code(processedDate);
                    processedDate = new Date(processedDate.y, processedDate.m - 1, processedDate.d);
                } else if (typeof processedDate === 'string') {
                    processedDate = new Date(processedDate);
                } else if (processedDate instanceof Date) {
                    processedDate = processedDate;
                } else {
                    processedDate = null;
                }
                
                return {
                    registrationNumber: row[0],
                    callName: row[1],
                    date: processedDate,
                    level: row[3],
                    results: row[4],
                    judge: row[5],
                    points: parseFloat(row[6]) || 0
                };
            }).filter(record => record.registrationNumber && record.level);
            
            isDataLoaded = true;
            console.log('Data processed:', trialingData.length, 'records');
        }

        function updateLastUpdatedDate() {
            if (trialingData.length === 0) {
                document.getElementById('lastUpdated').textContent = 'No data available';
                return;
            }

            const validDates = trialingData
                .map(record => record.date)
                .filter(date => date instanceof Date && !isNaN(date))
                .sort((a, b) => b - a);

            if (validDates.length > 0) {
                const mostRecentDate = validDates[0];
                document.getElementById('lastUpdated').textContent = 
                    `Data loaded successfully - Last updated: ${mostRecentDate.toLocaleDateString()}`;
            } else {
                document.getElementById('lastUpdated').textContent = 'Data loaded successfully';
            }
        }

        function showSuccessMessage() {
            document.getElementById('summaryContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
                        <h3 style="margin-bottom: 10px;">✅ Data Loaded Successfully!</h3>
                        <p>Loaded ${trialingData.length} trialing records</p>
                    </div>
                    <p>Use the search box above to look up a dog's records, or use Owner View to see all dogs for an owner.</p>
                </div>
                
                <div class="validation-rules">
                    <h4>Title Requirements</h4>
                    <ul>
                        <li>Minimum 4 points required for each level</li>
                        <li>Points must come from at least 2 different judges</li>
                        <li>Prerequisites must be met before advancing to higher levels</li>
                        <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                        <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                        <li>Ace awards given every 10 points after title is earned</li>
                    </ul>
                </div>
            `;
        }

        function formatRegistrationNumber(input) {
            if (!input) return '';
            
            let cleaned = input.replace(/[^0-9-]/g, '');
            
            if (cleaned.includes('-')) {
                let parts = cleaned.split('-');
                if (parts.length === 3) {
                    let part1 = parts[0].padStart(2, '0').substring(0, 2);
                    let part2 = parts[1].padStart(4, '0').substring(0, 4);
                    let part3 = parts[2].padStart(2, '0').substring(0, 2);
                    return `${part1}-${part2}-${part3}`;
                }
            }
            
            const digitsOnly = cleaned.replace(/-/g, '');
            if (digitsOnly.length >= 6) {
                const part1 = digitsOnly.substring(0, 2).padStart(2, '0');
                const part2 = digitsOnly.substring(2, 6).padStart(4, '0');
                const part3 = digitsOnly.substring(6, 8).padStart(2, '0');
                return `${part1}-${part2}-${part3}`;
            }
            
            if (digitsOnly.length === 4) {
                return `XX-${digitsOnly}-XX`;
            }
            
            return cleaned;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchDog();
            }
        }

        function searchDog() {
            if (!isDataLoaded) {
                alert('Please load trialing data first');
                return;
            }

            const searchInput = document.getElementById('searchInput').value.trim();
            if (!searchInput) {
                alert('Please enter a registration number');
                return;
            }

            const formattedSearch = formatRegistrationNumber(searchInput);
            
            const dogRecords = trialingData.filter(record => 
                record.registrationNumber && 
                record.registrationNumber.toLowerCase() === formattedSearch.toLowerCase()
            );

            if (dogRecords.length === 0) {
                const partialMatches = trialingData.filter(record =>
                    record.registrationNumber && 
                    record.registrationNumber.toLowerCase().includes(formattedSearch.toLowerCase())
                ).slice(0, 5);

                let errorMessage = `No dog found with registration number: <strong>${formattedSearch}</strong>`;
                
                if (partialMatches.length > 0) {
                    errorMessage += '<br><br><strong>Did you mean:</strong><ul style="text-align: left; margin: 10px 0;">';
                    partialMatches.forEach(match => {
                        errorMessage += `<li><a href="#" onclick="searchSpecific('${match.registrationNumber}')" style="color: #007bff; text-decoration: underline;">${match.registrationNumber} (${match.callName || 'Unknown'})</a></li>`;
                    });
                    errorMessage += '</ul>';
                }

                document.getElementById('summaryContent').innerHTML = 
                    `<div class="error-message">${errorMessage}</div>`;
                return;
            }

            currentDogRecords = dogRecords;
            displaySummary(dogRecords);
        }

        function searchSpecific(regNumber) {
            document.getElementById('searchInput').value = regNumber;
            searchDog();
        }

        function displaySummary(records) {
            const regNumber = records[0].registrationNumber;
            const callName = records[0].callName || 'Unknown';
            
            const levelSummary = {};
            
            records.forEach(record => {
                if (!record.level) return;
                
                if (!levelSummary[record.level]) {
                    levelSummary[record.level] = {
                        totalPoints: 0,
                        judges: new Set(),
                        records: []
                    };
                }
                
                if (record.points > 0) {
                    levelSummary[record.level].totalPoints += record.points;
                    if (record.judge) {
                        levelSummary[record.level].judges.add(record.judge);
                    }
                }
                levelSummary[record.level].records.push(record);
            });

            const validatedLevels = applyValidationRules(levelSummary);

            let html = `
                <div class="dog-info">
                    <h3>${callName}</h3>
                    <p><strong>Registration:</strong> ${regNumber}</p>
                    <p><strong>Total Trialing Records:</strong> ${records.length}</p>
                </div>
            `;
            
            getSortedLevels(levelSummary).forEach(level => {
                const summary = levelSummary[level];
                const isValidated = validatedLevels[level];
                const judgeCount = summary.judges.size;
                
                const hasTitleRequirements = summary.totalPoints >= 4 && judgeCount >= 2 && isValidated;
                
                // For Games levels, also check if they have enough different games
                let gamesInfo = '';
                if (level.startsWith('Games ')) {
                    const uniqueGames = getUniqueGames(summary.records);
                    gamesInfo = `<div><span>Different Games:</span> <strong>${uniqueGames.size}/2</strong> (${Array.from(uniqueGames).join(', ') || 'None'})</div>`;
                }
                
                // Calculate title points and ace points
                let titlePoints = 0;
                let acePoints = 0;
                let titleStatus = '';
                let titleClass = '';
                let titleInfo = null;
                
                if (hasTitleRequirements) {
                    titleInfo = calculateTitlePoints(summary.records);
                    titlePoints = titleInfo.titlePoints;
                    acePoints = Math.max(0, summary.totalPoints - titlePoints);
                    
                    const officialTitle = titleAbbreviations[level] || level;
                    
                    if (acePoints >= 10) {
                        const aceCount = Math.floor(acePoints / 10);
                        titleStatus = aceCount === 1 ? `${officialTitle}A` : `${officialTitle}Ax${aceCount}`;
                        titleClass = 'title-earned';
                    } else {
                        titleStatus = `${officialTitle} Title Earned`;
                        titleClass = 'title-earned';
                    }
                } else {
                    titleStatus = 'No Title Yet';
                    titleClass = 'no-title';
                }
                
                html += `
                    <div class="level-summary">
                        <div class="level-info">
                            <h4>${level}</h4>
                            <div class="title-status ${titleClass}">${titleStatus}</div>
                            
                            <div class="points-breakdown">
                                <div><span>Total Points:</span> <strong>${summary.totalPoints}</strong></div>
                                <div><span>Judges:</span> <strong>${judgeCount}/2</strong></div>
                                ${gamesInfo}
                                ${hasTitleRequirements ? `
                                    <div><span>Points Towards Title:</span> <strong>${titlePoints}</strong></div>
                                    <div><span>Points Towards Ace:</span> <strong class="ace-info">${acePoints}</strong></div>
                                    ${titleInfo && titleInfo.titleDate ? `<div style="color: #28a745; font-size: 0.85rem;"><span>Title Earned:</span> <strong>${titleInfo.titleDate instanceof Date && !isNaN(titleInfo.titleDate) ? titleInfo.titleDate.toLocaleDateString() : 'N/A'}</strong></div>` : ''}
                                    ${acePoints < 10 && acePoints >= 0 ? `<div class="ace-info"><span>Points until next Ace:</span> <strong>${10 - (acePoints % 10)}</strong></div>` : 
                                    acePoints >= 10 ? `<div class="ace-info"><span>Points until next Ace:</span> <strong>${10 - (acePoints % 10)}</strong></div>` : ''}
                                ` : `
                                    <div style="color: #dc3545;">
                                        <div><span>Need:</span> ${summary.totalPoints < 4 ? `${4 - summary.totalPoints} more points` : ''}
                                        ${summary.totalPoints < 4 && judgeCount < 2 ? ', ' : ''}
                                        ${judgeCount < 2 ? `${2 - judgeCount} more judge${judgeCount === 0 ? 's' : ''}` : ''}
                                        ${level.startsWith('Games ') && getUniqueGames(summary.records).size < 2 ? 
                                            `${(summary.totalPoints < 4 || judgeCount < 2) ? ', ' : ''}${2 - getUniqueGames(summary.records).size} more different game${getUniqueGames(summary.records).size === 0 ? 's' : ''}` : ''}</div>
                                        ${!isValidated && !level.startsWith('Games ') ? `<div><span>Prerequisites:</span> ${getPrerequisiteText(level)}</div>` : ''}
                                    </div>
                                `}
                            </div>
                        </div>
                        <div>
                            <button class="details-btn" onclick="showLevelDetails('${escapeJs(level)}', '${escapeJs(callName)}')">Details</button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('summaryContent').innerHTML = html || '<div class="error-message">No level data to display</div>';
        }

        function getSortedLevels(levelSummary) {
            const availableLevels = Object.keys(levelSummary);
            const orderedLevels = levelOrder.filter(level => availableLevels.includes(level));
            const unorderedLevels = availableLevels.filter(level => !levelOrder.includes(level));
            return [...orderedLevels, ...unorderedLevels.sort()];
        }

        function calculateTitlePoints(records) {
            const sortedRecords = records
                .filter(r => r.points > 0 && r.date instanceof Date && !isNaN(r.date))
                .sort((a, b) => a.date - b.date);
            
            let cumulativePoints = 0;
            let judges = new Set();
            
            for (const record of sortedRecords) {
                const prevPoints = cumulativePoints;
                const prevJudgeCount = judges.size;
                
                cumulativePoints += record.points;
                if (record.judge) judges.add(record.judge);
                
                const nowHasTitle = cumulativePoints >= 4 && judges.size >= 2;
                const previouslyHadTitle = prevPoints >= 4 && prevJudgeCount >= 2;
                
                if (nowHasTitle && !previouslyHadTitle) {
                    let pointsTowardTitle = record.points;
                    
                    if (prevPoints >= 4 && prevJudgeCount < 2) {
                        pointsTowardTitle = 1;
                    } else if (prevJudgeCount >= 2 && prevPoints < 4) {
                        pointsTowardTitle = 4 - prevPoints;
                    } else if (prevPoints < 4 && prevJudgeCount < 2) {
                        pointsTowardTitle = Math.min(record.points, 4 - prevPoints);
                    }
                    
                    return {
                        titlePoints: prevPoints + pointsTowardTitle,
                        titleDate: record.date
                    };
                }
            }
            
            return {
                titlePoints: cumulativePoints,
                titleDate: sortedRecords[sortedRecords.length - 1]?.date
            };
        }

        function applyValidationRules(levelSummary) {
            const validatedLevels = {};
            
            Object.keys(levelSummary).forEach(level => {
                if (!prerequisites[level] && !level.startsWith('Games ')) {
                    validatedLevels[level] = true;
                }
            });

            Object.keys(levelSummary).forEach(level => {
                if (level.startsWith('Games ')) {
                    const summary = levelSummary[level];
                    const uniqueGames = getUniqueGames(summary.records);
                    const hasEnoughGames = uniqueGames.size >= 2;
                    const hasBasicRequirements = summary.totalPoints >= 4 && summary.judges.size >= 2;
                    validatedLevels[level] = hasEnoughGames && hasBasicRequirements;
                }
            });

            Object.keys(prerequisites).forEach(level => {
                if (!levelSummary[level]) {
                    validatedLevels[level] = false;
                    return;
                }

                let meetsPrereqCriteria = false;

                if (level === "Investigator 3") {
                    const patrol1Valid = checkLevelRequirements(levelSummary["Patrol 1"]);
                    const detective2Valid = checkLevelRequirements(levelSummary["Detective 2"]);
                    meetsPrereqCriteria = patrol1Valid || detective2Valid;
                } else {
                    const prereqLevel = prerequisites[level][0];
                    meetsPrereqCriteria = checkLevelRequirements(levelSummary[prereqLevel]);
                }

                validatedLevels[level] = meetsPrereqCriteria;
            });

            return validatedLevels;
        }

        function getUniqueGames(records) {
            const games = new Set();
            const gamesList = ['BJ', 'C', 'P', 'T', 'GB'];
            
            records.forEach(record => {
                if (record.results) {
                    const results = record.results.toString().toUpperCase();
                    gamesList.forEach(game => {
                        if (results.includes(game)) {
                            games.add(game);
                        }
                    });
                }
            });
            
            return games;
        }

        function checkLevelRequirements(levelData) {
            if (!levelData) return false;
            return levelData.totalPoints >= 4 && levelData.judges.size >= 2;
        }

        function getPrerequisiteText(level) {
            if (!prerequisites[level]) return 'None';
            
            if (level === "Investigator 3") {
                return 'Either "Patrol 1" OR "Detective 2" (4+ points, 2+ judges each)';
            }
            
            return `"${prerequisites[level][0]}" (4+ points, 2+ judges)`;
        }

        function showLevelDetails(level, dogName) {
            const records = currentDogRecords.filter(r => r.level === level);
            
            document.getElementById('modalTitle').textContent = `${dogName} - ${level} Details`;
            
            let html = `
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Judge</th>
                            <th>Results</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            records.sort((a, b) => new Date(a.date) - new Date(b.date));

            records.forEach(record => {
                const date = record.date && record.date instanceof Date && !isNaN(record.date) 
                    ? record.date.toLocaleDateString() 
                    : 'N/A';
                const pointsClass = record.points > 0 ? 'points-badge' : 'points-badge zero';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${record.judge || 'N/A'}</td>
                        <td>${record.results || 'N/A'}</td>
                        <td><span class="${pointsClass}">${record.points}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function showOwnerView() {
            if (!isDataLoaded) {
                alert('Please load trialing data first');
                return;
            }

            document.getElementById('summaryContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #17a2b8; margin-bottom: 20px;">👤 Owner View</h3>
                    <p style="margin-bottom: 20px;">Enter the middle 4 digits from your registration number:</p>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; border: 2px solid #dee2e6; margin: 20px 0;">
                        <input type="text" id="ownerIdInput" placeholder="e.g., 1734" 
                               style="padding: 15px 20px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 10px; width: 200px; text-align: center;"
                               onkeypress="handleOwnerKeyPress(event)" maxlength="4">
                        <br><br>
                        <button onclick="loadOwnerView()" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 1.1rem;">
                            📊 Load Owner View
                        </button>
                    </div>
                    
                    <button onclick="backToMain()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        ← Back to Search
                    </button>
                </div>
            `;
        }

        function handleOwnerKeyPress(event) {
            if (event.key === 'Enter') {
                loadOwnerView();
            }
        }

        function loadOwnerView() {
            const ownerIdInput = document.getElementById('ownerIdInput');
            if (!ownerIdInput) {
                console.error('Owner ID input not found');
                return;
            }
            
            const ownerId = ownerIdInput.value.trim();
            
            if (!ownerId) {
                alert('Please enter the middle 4 digits');
                return;
            }

            if (!/^\d{4}$/.test(ownerId)) {
                alert('Please enter exactly 4 digits');
                return;
            }

            // Find all dogs with matching middle 4 digits
            const matchingDogs = trialingData.filter(record => {
                if (!record.registrationNumber) return false;
                const regParts = record.registrationNumber.split('-');
                return regParts.length >= 2 && regParts[1] === ownerId;
            });

            if (matchingDogs.length === 0) {
                document.getElementById('summaryContent').innerHTML = `
                    <div class="error-message">No dogs found with owner ID: <strong>${ownerId}</strong></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="showOwnerView()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ← Try Again
                        </button>
                    </div>
                `;
                return;
            }

            // Group by unique registration numbers
            const dogsByReg = {};
            matchingDogs.forEach(record => {
                if (!dogsByReg[record.registrationNumber]) {
                    dogsByReg[record.registrationNumber] = [];
                }
                dogsByReg[record.registrationNumber].push(record);
            });

            const dogRegistrations = Object.keys(dogsByReg);
            let html = `
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <h3 style="margin: 0; font-size: 1.4rem;">${dogRegistrations.length} dog(s) found for owner ID: ${ownerId}</h3>
                </div>
            `;

            dogRegistrations.forEach(regNumber => {
                const dogRecords = dogsByReg[regNumber];
                const callName = dogRecords[0].callName || 'Unknown';
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #2c3e50;">${callName} (${regNumber})</h4>
                            <button onclick="searchSpecific('${regNumber}')" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                View Details
                            </button>
                        </div>
                        <p style="color: #6c757d; margin: 0;">Total Records: ${dogRecords.length}</p>
                    </div>
                `;
            });

            html += `
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="showOwnerView()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-right: 10px;">
                        ← Change Owner ID
                    </button>
                    <button onclick="backToMain()" style="background: #17a2b8; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Back to Search
                    </button>
                </div>
            `;

            document.getElementById('summaryContent').innerHTML = html;
        }

        function backToMain() {
            if (isDataLoaded) {
                showSuccessMessage();
            } else {
                document.getElementById('summaryContent').innerHTML = `
                    <div class="upload-section">
                        <h3 style="color: #17a2b8; margin-bottom: 20px;">📁 Upload Data File</h3>
                        <p style="margin-bottom: 20px;">Select your Excel file to load the trialing data:</p>
                        
                        <div class="upload-area">
                            <input type="file" id="dataFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 15px;">
                            <br>
                            <button class="upload-btn" onclick="loadFile()">
                                📤 Load File
                            </button>
                        </div>
                        
                        <button class="retry-btn" onclick="tryAutoLoad()">
                            🔄 Try Auto-Loading From Server
                        </button>
                    </div>
                    
                    <div class="validation-rules">
                        <h4>Title Requirements</h4>
                        <ul>
                            <li>Minimum 4 points required for each level</li>
                            <li>Points must come from at least 2 different judges</li>
                            <li>Prerequisites must be met before advancing to higher levels</li>
                            <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                            <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                            <li>Ace awards given every 10 points after title is earned</li>
                        </ul>
                    </div>
                `;
            }
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 CWAGS Tracker ready');
            // Don't auto-load - wait for user action
        });
    </script>
</body>
</html>
