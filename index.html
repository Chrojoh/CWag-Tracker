<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Trialing Records Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(90deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .last-updated {
            opacity: 0.8;
            font-size: 0.95rem;
            font-style: italic;
        }

        .logo {
            width: 160px;
            height: 160px;
            background-image: url('https://raw.githubusercontent.com/cwagtracker/Tracker/main/cwags-logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .owner-view-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .owner-view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .main-content {
            padding: 30px;
        }

        .summary-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
        }

        .section-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-content {
            padding: 20px;
        }

        .dog-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .dog-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .dog-info p {
            color: #7f8c8d;
            margin: 5px 0;
        }

        .handler-name {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .level-summary {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: start;
        }

        .level-info {
            flex: 1;
        }

        .level-summary h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-status {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .title-earned {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .no-title {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .points-breakdown {
            font-size: 0.9rem;
            margin: 8px 0;
        }

        .points-breakdown div {
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
        }

        .ace-info {
            color: #6f42c1;
            font-weight: 600;
        }

        .details-btn {
            background: linear-gradient(45deg, #17a2b8, #20c997);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            align-self: start;
        }

        .details-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }

        .certificate-btn {
            background: linear-gradient(45deg, #6f42c1, #8e44ad);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            align-self: start;
            margin-top: 8px;
        }

        .certificate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
        }

        .certificate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .certificate-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .records-table th,
        .records-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        .records-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .points-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .points-badge.zero {
            background: #dc3545;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .validation-rules {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .validation-rules h4 {
            color: #004085;
            margin-bottom: 10px;
        }

        .validation-rules ul {
            margin-left: 20px;
        }

        .validation-rules li {
            color: #004085;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        /* Owner View Styles */
        .owner-view-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        .owner-grid {
            min-width: 800px;
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
        }

        .owner-grid th,
        .owner-grid td {
            border: 1px solid #dee2e6;
            padding: 8px 6px;
            text-align: center;
            vertical-align: middle;
        }

        .owner-grid th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .owner-grid th.dog-header {
            background: #f8f9fa;
            color: #2c3e50;
            min-width: 80px;
            max-width: 120px;
            font-size: 0.8rem;
            padding: 8px 4px;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .owner-grid th.dog-header:hover {
            background: #e9ecef;
            color: #007bff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .owner-grid tr:nth-child(even) {
            background: #f8f9fa;
        }

        .owner-grid tr:hover {
            background: #e3f2fd;
        }

        .owner-grid .level-cell {
            background: #e9ecef;
            font-weight: 600;
            color: #495057;
            text-align: left;
            padding-left: 12px;
        }

        .q-needed {
            background: #fff3cd;
            color: #856404;
            font-weight: 600;
        }

        .title-ready {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .ace-progress {
            background: #e7e3ff;
            color: #6f42c1;
            font-weight: 600;
        }

        .no-data {
            background: #f8d7da;
            color: #721c24;
        }

        .back-to-search {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-to-search:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .legend-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-container h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .legend-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-box {
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .requirements-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                padding: 5px !important;
                margin: 0 !important;
                font-size: 10px !important;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: none !important;
                width: 100% !important;
                margin: 0 !important;
            }
            
            .header {
                background: #2c3e50 !important;
                color: white !important;
                padding: 10px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .logo {
                width: 50px !important;
                height: 50px !important;
            }
            
            .header h1 {
                font-size: 1.2rem !important;
                margin-bottom: 3px !important;
            }
            
            .header p {
                font-size: 0.7rem !important;
                margin-bottom: 2px !important;
            }
            
            .last-updated {
                font-size: 0.6rem !important;
            }
            
            /* Hide buttons and non-essential elements */
            button, .search-section {
                display: none !important;
            }
            
            /* Print styles for owner view */
            .print-header { 
                display: block !important; 
            }
            
            .owner-grid { 
                width: 100% !important; 
                border-collapse: collapse !important; 
                font-size: 12px !important; 
                line-height: 1.1 !important; 
                table-layout: fixed !important; 
            }
            
            .owner-grid th, .owner-grid td { 
                border: 1px solid #333 !important; 
                padding: 4px 3px !important; 
                text-align: center !important; 
                vertical-align: middle !important; 
                line-height: 1.1 !important; 
            }
            
            .owner-grid th { 
                background: #2c3e50 !important; 
                color: white !important; 
                font-weight: 600 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                font-size: 12px !important; 
            }
            
            .owner-grid .level-cell { 
                background: #bdc3c7 !important; 
                color: #2c3e50 !important; 
                font-weight: 600 !important; 
                text-align: left !important; 
                padding-left: 8px !important; 
                font-size: 11px !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                line-height: 1.1 !important; 
                width: 100px !important; 
            }
            
            .dog-header { 
                background: #ecf0f1 !important; 
                color: #2c3e50 !important; 
                font-size: 10px !important; 
                padding: 4px 3px !important; 
                text-align: center !important;
                writing-mode: horizontal-tb !important;
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
                white-space: nowrap !important;
                line-height: 1.2 !important;
                font-weight: 600 !important;
                overflow: hidden !important;
            }
            
            .q-needed { 
                background: #fff3cd !important; 
                color: #856404 !important; 
                font-weight: 600 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                font-size: 11px !important; 
                line-height: 1.1 !important; 
            }
            
            .title-ready { 
                background: #d4edda !important; 
                color: #155724 !important; 
                font-weight: 600 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                font-size: 11px !important; 
                line-height: 1.1 !important; 
            }
            
            .ace-progress { 
                background: #e7e3ff !important; 
                color: #6f42c1 !important; 
                font-weight: 600 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                font-size: 11px !important; 
                line-height: 1.1 !important; 
            }
            
            .no-data { 
                background: #f8f9fa !important; 
                color: #6c757d !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                font-size: 11px !important; 
                line-height: 1.1 !important; 
            }
            
            .legend-container { 
                margin-top: 12px !important; 
                page-break-inside: avoid !important; 
                font-size: 11px !important; 
                border-top: 1px solid #333 !important; 
                padding-top: 8px !important; 
                line-height: 1.2 !important; 
            }
            
            .legend-container h4 { 
                font-size: 13px !important; 
                margin-bottom: 4px !important; 
                color: #2c3e50 !important; 
                line-height: 1.2 !important; 
            }
            
            .legend-grid { 
                display: flex !important; 
                flex-wrap: wrap !important; 
                gap: 15px !important; 
                margin-bottom: 4px !important; 
            }
            
            .legend-item { 
                display: flex !important; 
                align-items: center !important; 
                gap: 4px !important; 
            }
            
            .legend-box { 
                display: inline-block !important; 
                padding: 3px 6px !important; 
                border-radius: 3px !important; 
                font-weight: 600 !important; 
                font-size: 10px !important; 
            }
            
            .requirements-text { 
                font-size: 10px !important; 
                color: #666 !important; 
                margin-top: 4px !important; 
                line-height: 1.3 !important; 
            }
            
            /* Adjust margins for print */
            @page {
                margin: 0.3in !important;
                size: portrait !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div id="leftLogo" class="logo"></div>
                <div class="header-text">
                    <h1>CWAGS Tracker</h1>
                    <p>Track your dog's trialing progress, points, and title eligibility</p>
                    <div class="last-updated" id="lastUpdated">Loading data...</div>
                </div>
                <div id="rightLogo" class="logo"></div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="Enter Registration Number (e.g., 17-1734-06)" 
                       onkeypress="handleKeyPress(event)">
                <button class="search-btn" onclick="searchDog()">Search Dog Records</button>
                <button class="owner-view-btn" onclick="showOwnerView()">Owner View by ID</button>
            </div>
        </div>

        <div class="main-content">
            <div class="summary-section">
                <div class="section-header">Points Summary & Title Progress</div>
                <div class="section-content" id="summaryContent">
                    <div class="loading-message">
                        Loading trialing data...
                    </div>
                    <div class="validation-rules">
                        <h4>Title Requirements</h4>
                        <ul>
                            <li>Minimum 4 points required for each level</li>
                            <li>Points must come from at least 2 different judges</li>
                            <li>Prerequisites must be met before advancing to higher levels</li>
                            <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                            <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                            <li>Ace awards given every 10 points after title is earned</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for showing detailed records -->
        <div id="detailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Level Details</h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js" onerror="console.error('Fontkit failed to load from unpkg')"></script>
    <script>
        // Backup fontkit loading
        if (typeof fontkit === 'undefined') {
            console.log('Loading fontkit from backup CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdn.skypack.dev/@pdf-lib/fontkit@1.1.1';
            script.onerror = () => console.error('Backup fontkit also failed');
            document.head.appendChild(script);
        }
    </script>
    <script>
        let trialingData = [];
        let currentDogRecords = [];
        let dogInfoData = {}; // Store DogInfo.xlsx data for lookup
        let titlePlacementData = {}; // Store Title Placement mapping data
        
        // Level prerequisites mapping
        const prerequisites = {
            "Investigator 3": ["Patrol 1", "Detective 2"],  // Special case - either/or
            "Super Sleuth 4": ["Investigator 3"],
            "Private Inv": ["Super Sleuth 4"],
            "Det Diversions": ["Super Sleuth 4"],
            "Ranger 2": ["Ranger 1"],
            "Ranger 3": ["Ranger 2"],
            "Ranger 4": ["Ranger 3"],
            "Ranger 5": ["Ranger 4"],
            "Dasher 4": ["Dasher 3"],
            "Dasher 5": ["Dasher 4"],
            "Dasher 6": ["Dasher 5"],
            "Obedience 4": ["Obedience 3"],
            "Obedience 5": ["Obedience 4"]
        };

        // Official title abbreviations
        const titleAbbreviations = {
            "Patrol 1": "CW-SP",
            "Detective 2": "CW-SD",
            "Investigator 3": "CW-SI",
            "Super Sleuth 4": "CW-SS",
            "Private Inv": "CW-SPI",
            "Det Diversions": "CW-SDD",
            "Ranger 1": "CW-ScR1",
            "Ranger 2": "CW-ScR2",
            "Ranger 3": "CW-ScR3",
            "Ranger 4": "CW-ScR4",
            "Ranger 5": "CW-ScR5",
            "Dasher 3": "CW-SD3",
            "Dasher 4": "CW-SD4",
            "Dasher 5": "CW-SD5",
            "Dasher 6": "CW-SD6",
            "Obedience 1": "CW-Ob1",
            "Obedience 2": "CW-Ob2",
            "Obedience 3": "CW-Ob3",
            "Obedience 4": "CW-Ob4",
            "Obedience 5": "CW-Ob5",
            "Starter": "CW-SR",
            "Advanced": "CW-AR",
            "Pro": "CW-PR",
            "ARF": "CW-ARF",
            "Zoom 1": "CW-ZR1",
            "Zoom 1.5": "CW-ZR1.5",
            "Zoom 2": "CW-ZR2",
            "Games 1": "CW-G1",
            "Games 2": "CW-G2",
            "Games 3": "CW-G3",
            "Games 4": "CW-G4"
        };

        // Certificate template mapping
        const certificateTemplateMapping = {
            'Patrol 1': { template: 'Scent.pdf', category: 'scent' },
            'Detective 2': { template: 'Scent.pdf', category: 'scent' },
            'Investigator 3': { template: 'Scent.pdf', category: 'scent' },
            'Super Sleuth 4': { template: 'Scent.pdf', category: 'scent' },
            'Private Inv': { template: 'Scent.pdf', category: 'scent' },
            'Det Diversions': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 1': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 2': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 3': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 4': { template: 'Scent.pdf', category: 'scent' },
            'Ranger 5': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 3': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 4': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 5': { template: 'Scent.pdf', category: 'scent' },
            'Dasher 6': { template: 'Scent.pdf', category: 'scent' },
            'Obedience 1': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 2': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 3': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 4': { template: 'Obedience.pdf', category: 'obedience' },
            'Obedience 5': { template: 'Obedience.pdf', category: 'obedience' },
            'Starter': { template: 'Rally.pdf', category: 'rally' },
            'Advanced': { template: 'Rally.pdf', category: 'rally' },
            'Pro': { template: 'Rally.pdf', category: 'rally' },
            'ARF': { template: 'Rally.pdf', category: 'rally' },
            'Zoom 1': { template: 'Rally.pdf', category: 'rally' },
            'Zoom 1.5': { template: 'Rally.pdf', category: 'rally' },
            'Zoom 2': { template: 'Rally.pdf', category: 'rally' },
            'Games 1': { template: 'Games.pdf', category: 'games' },
            'Games 2': { template: 'Games.pdf', category: 'games' },
            'Games 3': { template: 'Games.pdf', category: 'games' },
            'Games 4': { template: 'Games.pdf', category: 'games' }
        };

        // Title certificate positioning
        const titleCertificateConfig = {
            registrationNumber: { x: 120, y: 400, size: 12, color: [0, 0, 0] },
            handlerName: { x: 414, y: 370, size: 30, color: [0, 0, 0], align: 'center' },
            dogName: { x: 414, y: 280, size: 30, color: [0, 0, 0], align: 'center' },
            dateEarned: { x: 82, y: 235, size: 12, color: [0, 0, 0] },
            titleAbbreviation: { x: 700, y: 175, size: 30, color: [0, 0, 0.8], align: 'right' }
        };

        // ACE certificate positioning
        const aceCertificateConfig = {
            dateLine: { x: 448, y: 425, size: 12, color: [0, 0, 0], align: 'center' },
            levelAbbreviation: { x: 398, y: 355, size: 31, color: [0.85, 0.65, 0.13], align: 'center' },
            callName: { x: 398, y: 270, size: 28, color: [0, 0, 0], align: 'center' },
            handlerName: { x: 398, y: 180, size: 28, color: [0, 0, 0], align: 'left' },
            registrationNumber: { x: 540, y: 150, size: 12, color: [0, 0, 0], align: 'left' }
        };

        // Proper level ordering
        const levelOrder = [
            "Patrol 1", "Detective 2", "Investigator 3", "Super Sleuth 4", "Private Inv", "Det Diversions",
            "Ranger 1", "Ranger 2", "Ranger 3", "Ranger 4", "Ranger 5",
            "Dasher 3", "Dasher 4", "Dasher 5", "Dasher 6",
            "Obedience 1", "Obedience 2", "Obedience 3", "Obedience 4", "Obedience 5",
            "Starter", "Advanced", "Pro", "ARF",
            "Zoom 1", "Zoom 1.5", "Zoom 2",
            "Games 1", "Games 2", "Games 3", "Games 4"
        ];

        function escapeHtml(text) {
            if (!text) return '';
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function escapeJs(text) {
            if (!text) return '';
            return text.toString()
                .replace(/\\/g, "\\\\")
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, "\\n")
                .replace(/\r/g, "\\r");
        }

        // Load DogInfo.xlsx data with timeout and error handling
        async function loadDogInfoData() {
            return new Promise((resolve) => {
                const timeoutId = setTimeout(() => {
                    console.warn('⏰ DogInfo loading timed out - continuing without it');
                    resolve(false);
                }, 2000);

                fetch('DogInfo.xlsx', {
                    method: 'GET',
                    cache: 'no-cache'
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.arrayBuffer();
                })
                .then(fileContent => {
                    const workbook = XLSX.read(new Uint8Array(fileContent), { 
                        cellStyles: true, 
                        cellFormulas: true, 
                        cellDates: true 
                    });
                    
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
                    
                    let loadedCount = 0;
                    // Process DogInfo data - skip header row
                    jsonData.slice(1).forEach(row => {
                        if (row && row[0]) { // Column A is Registration Number
                            const regNumber = row[0].toString().trim();
                            const callName = row[1] ? row[1].toString().trim() : '';
                            const handlerName = row[2] ? row[2].toString().trim() : '';
                            const registeredName = row[3] ? row[3].toString().trim() : '';
                            
                            dogInfoData[regNumber] = {
                                callName: callName,
                                handlerName: handlerName,
                                registeredName: registeredName
                            };
                            loadedCount++;
                        }
                    });
                    
                    console.log('✅ DogInfo data loaded:', loadedCount, 'dogs');
                    resolve(true);
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.warn('⚠️ Could not load DogInfo data:', error.message);
                    console.log('💡 Continuing without DogInfo lookup');
                    resolve(false);
                });
            });
        }

        // Helper function to get handler name from DogInfo.xlsx
        function getHandlerNameFromDogInfo(regNumber) {
            if (!regNumber || !dogInfoData[regNumber]) return '';
            return dogInfoData[regNumber].handlerName || '';
        }

        // Helper function to get registered name from DogInfo.xlsx
        function getRegisteredNameFromDogInfo(regNumber) {
            if (!regNumber || !dogInfoData[regNumber]) return '';
            return dogInfoData[regNumber].registeredName || dogInfoData[regNumber].callName || '';
        }

        // Helper function to get call name from DogInfo.xlsx (fallback to trialing data)
        function getCallNameFromDogInfo(regNumber, fallbackCallName = '') {
            if (!regNumber || !dogInfoData[regNumber]) return fallbackCallName;
            return dogInfoData[regNumber].callName || fallbackCallName;
        }

        function getSortedLevels(levelSummary) {
            const availableLevels = Object.keys(levelSummary);
            const orderedLevels = levelOrder.filter(level => availableLevels.includes(level));
            const unorderedLevels = availableLevels.filter(level => !levelOrder.includes(level));
            return [...orderedLevels, ...unorderedLevels.sort()];
        }

        // Load Title Placement data with timeout and error handling
        async function loadTitlePlacementData() {
            return new Promise((resolve) => {
                // Set a 2 second timeout to prevent hanging
                const timeoutId = setTimeout(() => {
                    console.warn('⏰ Title Placement loading timed out - continuing without it');
                    resolve(false);
                }, 2000);

                fetch('Title Placement.xlsx', {
                    method: 'GET',
                    cache: 'no-cache'
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.arrayBuffer();
                })
                .then(fileContent => {
                    const workbook = XLSX.read(new Uint8Array(fileContent), { 
                        cellStyles: true, 
                        cellFormulas: true, 
                        cellDates: true 
                    });
                    
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});
                    
                    let loadedCount = 0;
                    jsonData.slice(1).forEach(row => {
                        if (row && row[1] && row[2] && row[3]) {
                            const className = row[1].toString().trim();
                            const certificateName = row[2].toString().trim();
                            const aceCertificateName = row[3].toString().trim();
                            
                            titlePlacementData[className] = {
                                certificateName: certificateName,
                                aceCertificateName: aceCertificateName
                            };
                            loadedCount++;
                        }
                    });
                    
                    console.log('✅ Title Placement data loaded:', loadedCount, 'classes');
                    resolve(true);
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.warn('⚠️ Could not load Title Placement data:', error.message);
                    console.log('💡 Continuing with original certificate names');
                    resolve(false);
                });
            });
        }

        // Get certificate name (Column C)
        function getCertificateName(level) {
            return titlePlacementData[level]?.certificateName || level;
        }

        // Helper function to get ACE certificate name (Column D + abbreviation in brackets + multiplier)
        function getAceCertificateName(level, aceCount) {
            const abbreviation = titleAbbreviations[level] || level;
            
            if (titlePlacementData[level]) {
                let aceName = titlePlacementData[level].aceCertificateName;
                
                // Format: "Scent Patrol Ace x 4 (CW-SPAx4)" for multiple, "Scent Patrol Ace (CW-SPA)" for single
                let aceDesignation;
                let displayText;
                
                if (aceCount === 1) {
                    aceDesignation = `${abbreviation}A`;
                    displayText = `${aceName} (${aceDesignation})`;
                } else {
                    aceDesignation = `${abbreviation}Ax${aceCount}`;
                    displayText = `${aceName} x ${aceCount} (${aceDesignation})`;
                }
                
                return displayText;
            }
            
            // Fallback to original system if not found
            return aceCount === 1 ? `${abbreviation}A` : `${abbreviation}Ax${aceCount}`;
        }

        // Generate title certificate
        async function generateTitleCertificate(level, regNumber, abbreviation) {
            try {
                const btn = event.target;
                btn.textContent = 'Generating...';
                btn.disabled = true;

                const templateInfo = certificateTemplateMapping[level];
                if (!templateInfo) throw new Error(`No template mapped for level: ${level}`);

                const levelRecords = trialingData.filter(r => r.registrationNumber === regNumber && r.level === level);
                if (levelRecords.length === 0) throw new Error('No records found for this level');

                const titleInfo = calculateTitlePoints(levelRecords);
                const dateEarned = titleInfo.titleDate ? titleInfo.titleDate.toLocaleDateString() : new Date().toLocaleDateString();
                const certificateName = getCertificateName(level);

                // Get names from DogInfo.xlsx
                const handlerName = getHandlerNameFromDogInfo(regNumber) || 'Handler Name';
                const registeredName = getRegisteredNameFromDogInfo(regNumber) || 'Dog Name';

                const templateUrl = `https://raw.githubusercontent.com/cwagtracker/Tracker/main/templates/${templateInfo.template}`;
                const response = await fetch(templateUrl);
                if (!response.ok) throw new Error(`Template not found: ${templateUrl}`);
                
                const templateBytes = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(templateBytes);
                const firstPage = pdfDoc.getPages()[0];
                
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const timesBold = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRomanBold);
                let maiandraFont = timesBold;

                // Try to load custom font
                if (typeof fontkit !== 'undefined') {
                    try {
                        pdfDoc.registerFontkit(fontkit);
                        const fontUrls = [
                            'https://cdn.jsdelivr.net/gh/cwagtracker/Tracker@main/fonts/Maiandra%20GD.TTF',
                            'https://raw.githubusercontent.com/cwagtracker/Tracker/main/fonts/Maiandra%20GD.TTF'
                        ];
                        
                        for (const fontUrl of fontUrls) {
                            try {
                                const fontResponse = await fetch(fontUrl, { mode: 'cors' });
                                if (fontResponse.ok) {
                                    const fontBytes = await fontResponse.arrayBuffer();
                                    maiandraFont = await pdfDoc.embedFont(fontBytes);
                                    break;
                                }
                            } catch (e) { /* continue */ }
                        }
                    } catch (e) { /* use fallback */ }
                }

                // Add text to certificate
                const regConfig = titleCertificateConfig.registrationNumber;
                firstPage.drawText(regNumber, {
                    x: regConfig.x, y: regConfig.y, size: regConfig.size, font: font,
                    color: PDFLib.rgb(regConfig.color[0], regConfig.color[1], regConfig.color[2])
                });

                const handlerConfig = titleCertificateConfig.handlerName;
                const handlerTextWidth = maiandraFont.widthOfTextAtSize(handlerName, handlerConfig.size);
                const handlerX = handlerConfig.x - (handlerTextWidth / 2);
                firstPage.drawText(handlerName, {
                    x: handlerX, y: handlerConfig.y, size: handlerConfig.size, font: maiandraFont,
                    color: PDFLib.rgb(0, 0, 0)
                });

                const dogConfig = titleCertificateConfig.dogName;
                const dogTextWidth = maiandraFont.widthOfTextAtSize(registeredName, dogConfig.size);
                const dogX = dogConfig.x - (dogTextWidth / 2);
                firstPage.drawText(registeredName, {
                    x: dogX, y: dogConfig.y, size: dogConfig.size, font: maiandraFont,
                    color: PDFLib.rgb(0, 0, 0)
                });

                const dateConfig = titleCertificateConfig.dateEarned;
                firstPage.drawText('On ', {
                    x: dateConfig.x - 20, y: dateConfig.y, size: dateConfig.size, font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                firstPage.drawText(dateEarned, {
                    x: dateConfig.x, y: dateConfig.y, size: dateConfig.size, font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                const dateWidth = font.widthOfTextAtSize(dateEarned, dateConfig.size);
                firstPage.drawText(', has completed the requirements for the title of', {
                    x: dateConfig.x + dateWidth, y: dateConfig.y, size: dateConfig.size, font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });

                const titleConfig = titleCertificateConfig.titleAbbreviation;
                const titleText = `${certificateName} (${abbreviation})`;
                const titleTextWidth = timesBold.widthOfTextAtSize(titleText, titleConfig.size);
                firstPage.drawText(titleText, {
                    x: titleConfig.x - titleTextWidth, y: titleConfig.y, size: titleConfig.size, font: maiandraFont,
                    color: PDFLib.rgb(titleConfig.color[0], titleConfig.color[1], titleConfig.color[2])
                });

                const pdfBytes = await pdfDoc.save();
                
                downloadPDF(pdfBytes, `${registeredName}-${level.replace(/\s+/g, '-')}-Title-Certificate.pdf`);
                btn.textContent = '📜 Title Certificate';
                btn.disabled = false;

            } catch (error) {
                console.error('Certificate generation error:', error);
                alert(`Unable to generate certificate: ${error.message}`);
                
                const btn = event.target;
                btn.textContent = '📜 Title Certificate';
                btn.disabled = false;
            }
        }

        // Generate ACE certificate
        async function generateAceCertificate(level, regNumber, aceCount) {
            try {
                const btn = event.target;
                btn.textContent = 'Generating...';
                btn.disabled = true;

                const levelRecords = trialingData.filter(r => r.registrationNumber === regNumber && r.level === level);
                if (levelRecords.length === 0) throw new Error('No records found for this level');

                const titleInfo = calculateTitlePoints(levelRecords);
                const dateEarned = titleInfo.titleDate ? titleInfo.titleDate.toLocaleDateString() : new Date().toLocaleDateString();
                const aceCertificateName = getAceCertificateName(level, aceCount);

                // Get names from DogInfo.xlsx
                const handlerName = getHandlerNameFromDogInfo(regNumber) || 'Handler Name';
                const registeredName = getRegisteredNameFromDogInfo(regNumber) || 'Dog Name';

                // ACE certificates use dedicated Ace.pdf template
                const templateUrl = 'https://raw.githubusercontent.com/cwagtracker/Tracker/main/templates/Ace.pdf';
                const response = await fetch(templateUrl);
                if (!response.ok) throw new Error(`ACE template not found: ${templateUrl}`);
                
                const templateBytes = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(templateBytes);
                const firstPage = pdfDoc.getPages()[0];
                
                const helvetica = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const timesBold = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRomanBold);
                let maiandraFont = timesBold;

                // Try to load custom font
                if (typeof fontkit !== 'undefined') {
                    try {
                        pdfDoc.registerFontkit(fontkit);
                        const fontUrls = [
                            'https://cdn.jsdelivr.net/gh/cwagtracker/Tracker@main/fonts/Maiandra%20GD.TTF',
                            'https://raw.githubusercontent.com/cwagtracker/Tracker/main/fonts/Maiandra%20GD.TTF'
                        ];
                        
                        for (const fontUrl of fontUrls) {
                            try {
                                const fontResponse = await fetch(fontUrl, { mode: 'cors' });
                                if (fontResponse.ok) {
                                    const fontBytes = await fontResponse.arrayBuffer();
                                    maiandraFont = await pdfDoc.embedFont(fontBytes);
                                    break;
                                }
                            } catch (e) { /* continue */ }
                        }
                    } catch (e) { /* use fallback */ }
                }

                // Helper function for text alignment
                function drawTextWithAlignment(page, text, config, font) {
                    let x = config.x;
                    if (config.align === 'center') {
                        const textWidth = font.widthOfTextAtSize(text, config.size);
                        x = config.x - (textWidth / 2);
                    } else if (config.align === 'right') {
                        const textWidth = font.widthOfTextAtSize(text, config.size);
                        x = config.x - textWidth;
                    }
                    page.drawText(text, {
                        x: x, y: config.y, size: config.size, font: font,
                        color: PDFLib.rgb(config.color[0], config.color[1], config.color[2])
                    });
                }

                // Add text to ACE certificate
                const dateLineText = `This certifies that on ${dateEarned} the requirements have been met for the title of:`;
                drawTextWithAlignment(firstPage, dateLineText, aceCertificateConfig.dateLine, helvetica);

                drawTextWithAlignment(firstPage, registeredName, aceCertificateConfig.callName, maiandraFont);
                drawTextWithAlignment(firstPage, handlerName, aceCertificateConfig.handlerName, maiandraFont);
                drawTextWithAlignment(firstPage, regNumber, aceCertificateConfig.registrationNumber, helvetica);

                const pdfBytes = await pdfDoc.save();
                downloadPDF(pdfBytes, `${registeredName}-${level.replace(/\s+/g, '-')}-ACE-Certificate.pdf`);

                btn.textContent = '🏆 Ace Certificate';
                btn.disabled = false;

            } catch (error) {
                console.error('ACE certificate generation error:', error);
                alert(`Unable to generate ACE certificate: ${error.message}`);
                
                const btn = event.target;
                btn.textContent = '🏆 Ace Certificate';
                btn.disabled = false;
            }
        }

        // Helper functions
        function downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchDog();
            }
        }

        function showOwnerView() {
            if (trialingData.length === 0) {
                alert('Please wait for trialing data to load');
                return;
            }

            document.getElementById('summaryContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #17a2b8; margin-bottom: 20px;">👤 Owner View</h3>
                    <p style="margin-bottom: 20px;">Enter the middle 4 digits from your registration number:</p>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; border: 2px solid #dee2e6; margin: 20px 0;">
                        <input type="text" id="ownerIdInput" placeholder="e.g., 1734" 
                               style="padding: 15px 20px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 10px; width: 200px; text-align: center;"
                               onkeypress="handleOwnerKeyPress(event)" maxlength="4">
                        <br><br>
                        <button onclick="loadOwnerView()" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 1.1rem;">
                            📊 Load Owner View
                        </button>
                    </div>
                    
                    <button onclick="backToSearch()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        ← Back to Search
                    </button>
                </div>
            `;
        }

        function handleOwnerKeyPress(event) {
            if (event.key === 'Enter') {
                loadOwnerView();
            }
        }

        function loadOwnerView() {
            const ownerIdInput = document.getElementById('ownerIdInput');
            if (!ownerIdInput) {
                console.error('Owner ID input not found');
                return;
            }
            
            const ownerId = ownerIdInput.value.trim();
            
            if (!ownerId) {
                alert('Please enter the middle 4 digits');
                return;
            }

            if (!/^\d{4}$/.test(ownerId)) {
                alert('Please enter exactly 4 digits');
                return;
            }

            // Find all dogs with matching middle 4 digits
            const matchingDogs = trialingData.filter(record => {
                if (!record.registrationNumber) return false;
                const regParts = record.registrationNumber.split('-');
                return regParts.length >= 2 && regParts[1] === ownerId;
            });

            if (matchingDogs.length === 0) {
                document.getElementById('summaryContent').innerHTML = `
                    <div class="error-message">No dogs found with owner ID: <strong>${ownerId}</strong></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="showOwnerView()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ← Try Again
                        </button>
                    </div>
                `;
                return;
            }

            // Group by unique registration numbers
            const dogsByReg = {};
            matchingDogs.forEach(record => {
                if (!dogsByReg[record.registrationNumber]) {
                    dogsByReg[record.registrationNumber] = [];
                }
                dogsByReg[record.registrationNumber].push(record);
            });

            const dogRegistrations = Object.keys(dogsByReg);
            const dogCount = dogRegistrations.length;

            displayOwnerGrid(dogsByReg, ownerId, dogCount);
        }

        function displayOwnerGrid(dogsByReg, ownerId, dogCount) {
            // Calculate data for each dog
            const dogsData = Object.keys(dogsByReg).map(regNumber => {
                const dogRecords = dogsByReg[regNumber];
                
                // Get names - prioritize DogInfo.xlsx, fallback to trialing data
                const callName = getCallNameFromDogInfo(regNumber, dogRecords[0].callName) || 'Unknown';
                const handlerName = getHandlerNameFromDogInfo(regNumber);

                // Calculate level summaries
                const levelSummary = {};
                dogRecords.forEach(record => {
                    if (!record.level) return;
                    
                    if (!levelSummary[record.level]) {
                        levelSummary[record.level] = {
                            totalPoints: 0,
                            judges: new Set(),
                            records: []
                        };
                    }
                    
                    if (record.points > 0) {
                        levelSummary[record.level].totalPoints += record.points;
                        if (record.judge) {
                            levelSummary[record.level].judges.add(record.judge);
                        }
                    }
                    levelSummary[record.level].records.push(record);
                });

                return {
                    regNumber,
                    callName,
                    handlerName,
                    levelSummary
                };
            });

            // Create header with owner info and navigation
            let html = `
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <h3 style="margin: 0; font-size: 1.4rem;">${dogCount} dog(s) found</h3>
                </div>

                <div style="text-align: center; margin-bottom: 15px;">
                    <button onclick="showOwnerView()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-right: 10px;">
                        ← Change Owner ID
                    </button>
                    <button onclick="printOwnerView()" style="background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        🖨️ Print View
                    </button>
                </div>

                <div class="legend-print" style="margin-bottom: 15px; padding: 15px; background: #e7f3ff; border: 1px solid #b8daff; border-radius: 8px;">
                    <h4 style="color: #004085; margin-bottom: 10px;">Legend:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; font-size: 0.9rem; color: #004085;">
                        <div><span style="background: #d4edda; padding: 2px 6px; border-radius: 3px; margin-right: 8px;"><strong>Title!</strong></span> - Title earned</div>
                        <div><span style="background: #d4edda; padding: 2px 6px; border-radius: 3px; margin-right: 8px;"><strong>Ace2</strong></span> - Has earned Ace2</div>
                        <div><span style="background: linear-gradient(135deg, #e8f5e8, #d4edda); padding: 2px 6px; border-radius: 3px; margin-right: 8px;"><strong>3 → Ace</strong></span> - Needs 3 Q's for first Ace</div>
                        <div><span style="background: linear-gradient(135deg, #e8f5e8, #d4edda); padding: 2px 6px; border-radius: 3px; margin-right: 8px;"><strong>7 → Ace3</strong></span> - Needs 7 Q's for next Ace level</div>
                        <div><span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; margin-right: 8px;"><strong>3 Q's, 1 judge needed for title</strong></span> - Requirements to achieve Title</div>
                        <div><span style="color: #666; margin-right: 8px;"><strong>-</strong></span> - No entries at this level</div>
                    </div>
                </div>
            `;

            // Create the table
            html += `
                <div style="overflow-x: auto; border: 1px solid #dee2e6; border-radius: 8px;">
                    <table class="owner-view-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; position: sticky; left: 0; background: #f8f9fa; z-index: 10;">Level</th>
            `;

            // Add dog name headers (clickable) with handler info
            dogsData.forEach(dog => {
                const displayName = dog.callName.length > 6 ? dog.callName.substring(0, 6) : dog.callName;
                const escapedRegNumber = escapeJs(dog.regNumber);
                const handlerInfo = dog.handlerName ? `<br><small style="color: #6c757d; font-weight: normal; font-size: 0.6rem;">${escapeHtml(dog.handlerName)}</small>` : '';
                html += `
                    <th style="padding: 8px 4px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600; width: ${75/dogsData.length}%;">
                        <a href="javascript:void(0)" onclick="searchSpecificDog('${escapedRegNumber}')" 
                           style="color: #667eea; text-decoration: none; font-weight: bold; cursor: pointer; font-size: 0.8rem;"
                           onmouseover="this.style.textDecoration='underline'" 
                           onmouseout="this.style.textDecoration='none'">
                            ${escapeHtml(displayName)}
                        </a>
                        ${handlerInfo}
                        <br>
                        <small style="color: #6c757d; font-weight: normal; font-size: 0.7rem;">${escapeHtml(dog.regNumber)}</small>
                    </th>
                `;
            });

            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Add rows for each level
            levelOrder.forEach(level => {
                html += `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 8px 4px; border-right: 1px solid #dee2e6; font-weight: 600; background: #f8f9fa; font-size: 0.8rem;">${level}</td>
                `;

                dogsData.forEach(dog => {
                    const levelData = dog.levelSummary[level];
                    let cellContent = '-';
                    let cellStyle = 'padding: 10px 8px; text-align: center; border-right: 1px solid #f0f0f0;';

                    if (levelData) {
                        const totalPoints = levelData.totalPoints;
                        const judgeCount = levelData.judges.size;
                        const hasTitle = totalPoints >= 4 && judgeCount >= 2;

                        if (hasTitle) {
                            const titleInfo = calculateTitlePoints(levelData.records);
                            const titlePoints = titleInfo.titlePoints;
                            const acePoints = Math.max(0, totalPoints - titlePoints);
                            
                            if (acePoints >= 10) {
                                const aceCount = Math.floor(acePoints / 10);
                                const pointsToNextAce = 10 - (acePoints % 10);
                                const nextAceNumber = aceCount + 1;
                                
                                if (pointsToNextAce === 10) {
                                    // Exactly on an ACE milestone
                                    cellContent = `<strong style="color: #6f42c1;">Ace${aceCount}</strong>`;
                                } else {
                                    // Show Q's needed to next ACE
                                    cellContent = `<strong style="color: #6f42c1;">${pointsToNextAce} → Ace${nextAceNumber}</strong>`;
                                }
                                cellStyle += ' background: linear-gradient(135deg, #e8f5e8, #d4edda);';
                            } else {
                                // Has title but less than 10 ace points
                                const pointsToFirstAce = 10 - acePoints;
                                if (acePoints === 0) {
                                    cellContent = `<strong style="color: #155724;">Title!</strong>`;
                                } else {
                                    cellContent = `<strong style="color: #155724;">${pointsToFirstAce} → Ace</strong>`;
                                }
                                cellStyle += ' background: #d4edda;';
                            }
                        } else if (totalPoints > 0) {
                            const needMore = [];
                            if (totalPoints < 4) needMore.push(`${4 - totalPoints} Q's`);
                            if (judgeCount < 2) needMore.push(`${2 - judgeCount} judge${judgeCount === 0 ? 's' : ''} needed for title`);
                            
                            cellContent = `<span style="color: #856404;">${needMore.join(', ')}</span>`;
                            cellStyle += ' background: #fff3cd;';
                        }
                    }

                    html += `<td style="${cellStyle} font-size: 0.75rem;">${cellContent}</td>`;
                });

                html += '</tr>';
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="backToSearch()" style="background: #17a2b8; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Back to Dog Search
                    </button>
                </div>
            `;

            document.getElementById('summaryContent').innerHTML = html;
        }

        function printOwnerView() {
            window.print();
        }

        function searchSpecificDog(regNumber) {
            document.getElementById('searchInput').value = regNumber;
            searchDog();
        }level => {
                html += `<tr><td class="level-cell">${level}</td>`;
                
                sortedDogs.forEach(regNumber => {
                    const dog = ownerDogs[regNumber];
                    const dogRecords = dog.records.filter(r => r.level === level);
                    const analysis = analyzeProgressForOwnerView(dogRecords, level, dog.records);
                    
                    html += `<td class="${analysis.cellClass}">${analysis.cellContent}</td>`;
                });
                
                html += `</tr>`;
            });

            html += `</tbody></table>
                    
                    <div class="legend-container">
                        <h4>Legend:</h4>
                        <div class="legend-grid">
                            <div class="legend-item"><span class="legend-box q-needed" style="background: #fff3cd; color: #856404;">2Q</span> Q's needed for title</div>
                            <div class="legend-item"><span class="legend-box title-ready" style="background: #d4edda; color: #155724;">Title!</span> Title earned, ready to submit</div>
                            <div class="legend-item"><span class="legend-box ace-progress" style="background: #e7e3ff; color: #6f42c1;">3Q→Ace</span> Q's needed for next Ace</div>
                            <div class="legend-item"><span class="legend-box no-data" style="background: #f8d7da; color: #721c24;">-</span> No qualifying scores</div>
                        </div>
                        <p class="requirements-text">
                            <strong>Requirements:</strong> 4+ Q's from 2+ different judges | Games levels need 2+ different games | Prerequisites must be met for advanced levels
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = html;
        }

        // This function was causing the syntax error - removing it since we have a working owner view implementation

        function printOwnerView() {
            const printWindow = window.open('', '_blank');
            const printableArea = document.getElementById('printableArea');
            if (!printableArea) {
                alert('No content to print');
                return;
            }
            
            const clonedContent = printableArea.cloneNode(true);
            const printHeader = clonedContent.querySelector('.print-header');
            if (printHeader) {
                printHeader.style.display = 'block';
            }
            
            // Force horizontal text by replacing the dog header cells completely
            const dogHeaders = clonedContent.querySelectorAll('th.dog-header');
            dogHeaders.forEach(header => {
                // Get the text content and split by <br> or newlines
                const text = header.innerHTML.replace(/<br\s*\/?>/gi, ' ');
                header.innerHTML = text;
                // Remove all CSS classes and add a new one
                header.className = 'dog-header-horizontal';
            });
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>C-WAGS Owner Progress Report</title>
                    <style>
                        @page { size: 8.5in 11in; margin: 0.3in; }
                        body { font-family: Arial, sans-serif; font-size: 13px; line-height: 1.2; margin: 0; padding: 0; }
                        .print-header h2 { font-size: 22px; margin-bottom: 3px; color: #2c3e50; line-height: 1.2; }
                        .print-header p { font-size: 16px; color: #666; margin-bottom: 10px; line-height: 1.2; }
                        .owner-grid { width: 100%; border-collapse: collapse; font-size: 12px; line-height: 1.1; table-layout: fixed; }
                        .owner-grid th, .owner-grid td { border: 1px solid #333; padding: 4px 3px; text-align: center; vertical-align: middle; line-height: 1.1; }
                        .owner-grid th { background: #2c3e50 !important; color: white !important; font-weight: 600; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 12px; }
                        .owner-grid .level-cell { background: #bdc3c7 !important; color: #2c3e50 !important; font-weight: 600; text-align: left; padding-left: 8px; font-size: 11px; -webkit-print-color-adjust: exact; print-color-adjust: exact; line-height: 1.1; width: 100px; }
                        .dog-header-horizontal { 
                            background: #ecf0f1 !important; 
                            color: #2c3e50 !important; 
                            font-size: 10px !important; 
                            padding: 4px 3px !important; 
                            text-align: center !important;
                            writing-mode: horizontal-tb !important;
                            -webkit-print-color-adjust: exact !important; 
                            print-color-adjust: exact !important;
                            white-space: nowrap !important;
                            line-height: 1.2 !important;
                            font-weight: 600 !important;
                            overflow: hidden !important;
                        }
                        .q-needed { background: #fff3cd !important; color: #856404 !important; font-weight: 600; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 11px; line-height: 1.1; }
                        .title-ready { background: #d4edda !important; color: #155724 !important; font-weight: 600; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 11px; line-height: 1.1; }
                        .ace-progress { background: #e7e3ff !important; color: #6f42c1 !important; font-weight: 600; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 11px; line-height: 1.1; }
                        .no-data { background: #f8f9fa !important; color: #6c757d !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 11px; line-height: 1.1; }
                        .legend-container { margin-top: 12px; page-break-inside: avoid; font-size: 11px; border-top: 1px solid #333; padding-top: 8px; line-height: 1.2; }
                        .legend-container h4 { font-size: 13px; margin-bottom: 4px; color: #2c3e50; line-height: 1.2; }
                        .legend-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 4px; }
                        .legend-item { display: flex; align-items: center; gap: 4px; }
                        .legend-box { display: inline-block; padding: 3px 6px; border-radius: 3px; font-weight: 600; font-size: 10px; }
                        .requirements-text { font-size: 10px; color: #666; margin-top: 4px; line-height: 1.3; }
                    </style>
                </head>
                <body>
                    ${clonedContent.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            };
        }

        function checkPrerequisites(level, allDogRecords) {
            if (!prerequisites[level] && !level.startsWith('Games ')) {
                return true;
            }
            
            if (level.startsWith('Games ')) {
                return true;
            }
            
            if (level === "Investigator 3") {
                const patrol1Records = allDogRecords.filter(r => r.level === "Patrol 1");
                const detective2Records = allDogRecords.filter(r => r.level === "Detective 2");
                
                const patrol1Valid = checkLevelTitleRequirements(patrol1Records);
                const detective2Valid = checkLevelTitleRequirements(detective2Records);
                
                return patrol1Valid || detective2Valid;
            } else {
                const prereqLevel = prerequisites[level][0];
                const prereqRecords = allDogRecords.filter(r => r.level === prereqLevel);
                return checkLevelTitleRequirements(prereqRecords);
            }
        }

        function checkLevelTitleRequirements(records) {
            if (records.length === 0) return false;
            
            let totalPoints = 0;
            const judges = new Set();
            
            records.forEach(record => {
                if (record.points > 0) {
                    totalPoints += record.points;
                    if (record.judge) judges.add(record.judge);
                }
            });
            
            return totalPoints >= 4 && judges.size >= 2;
        }

        function searchSpecificDog(regNumber) {
            document.getElementById('searchInput').value = regNumber;
            searchDog();
        }

        function backToSearch() {
            document.getElementById('summaryContent').innerHTML = `
                <div class="validation-rules">
                    <h4>Title Requirements</h4>
                    <ul>
                        <li>Minimum 4 points required for each level</li>
                        <li>Points must come from at least 2 different judges</li>
                        <li>Prerequisites must be met before advancing to higher levels</li>
                        <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                        <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                        <li>Ace awards given every 10 points after title is earned</li>
                    </ul>
                </div>
            `;
        }

        function loadDataFromFile() {
            console.log('Starting data load process...');
            
            // Set a shorter timeout and better error handling
            const timeoutId = setTimeout(() => {
                console.log('Load timeout - showing manual upload option');
                showFileUpload();
            }, 5000); // Increased to 5 seconds

            // First try to load the expected file
            fetch('Data for Tracker web.xlsx')
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Fetch response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    console.log('File found, reading data...');
                    return response.arrayBuffer();
                })
                .then(data => {
                    console.log('Data received, size:', data.byteLength, 'bytes');
                    processExcelData(new Uint8Array(data));
                    updateLastUpdatedDate();
                    document.getElementById('summaryContent').innerHTML = `
                        <div class="validation-rules">
                            <h4>Title Requirements</h4>
                            <ul>
                                <li>Minimum 4 points required for each level</li>
                                <li>Points must come from at least 2 different judges</li>
                                <li>Prerequisites must be met before advancing to higher levels</li>
                                <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                                <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                                <li>Ace awards given every 10 points after title is earned</li>
                            </ul>
                        </div>
                    `;
                    console.log('Data processing complete');
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Error loading data:', error);
                    document.getElementById('lastUpdated').textContent = 'File not found - please upload manually';
                    showFileUpload();
                });
        }

        function showFileUpload() {
            document.getElementById('summaryContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #17a2b8; margin-bottom: 20px;">📁 Upload Data File</h3>
                    <p style="margin-bottom: 20px;">Select your Excel file to load the trialing data:</p>
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; border: 2px dashed #dee2e6; margin: 20px 0;">
                        <input type="file" id="manualDataFile" accept=".xlsx,.xls,.csv" style="margin-bottom: 15px;">
                        <br>
                        <button onclick="loadManualFile()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            📤 Load File
                        </button>
                    </div>
                    
                    <button onclick="loadDataFromFile()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-top: 15px;">
                        ← Try Auto-Loading Again
                    </button>
                </div>
            `;
        }

        function loadManualFile() {
            const fileInput = document.getElementById('manualDataFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file first');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    processExcelData(data);
                    updateLastUpdatedDate();
                    document.getElementById('summaryContent').innerHTML = `
                        <div class="validation-rules">
                            <h4>Title Requirements</h4>
                            <ul>
                                <li>Minimum 4 points required for each level</li>
                                <li>Points must come from at least 2 different judges</li>
                                <li>Prerequisites must be met before advancing to higher levels</li>
                                <li>Special case: "Investigator 3" requires either "Patrol 1" OR "Detective 2"</li>
                                <li>Games levels require at least 2 different games (BJ, C, P, T, GB)</li>
                                <li>Ace awards given every 10 points after title is earned</li>
                            </ul>
                        </div>
                    `;
                    alert(`Successfully loaded ${trialingData.length} records!`);
                } catch (error) {
                    console.error('Error loading manual file:', error);
                    alert(`Error loading file: ${error.message}`);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            
            // Look for Data sheet
            const dataSheet = workbook.Sheets['Data'] || workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(dataSheet, {header: 1, dateNF: 'yyyy-mm-dd'});
            
            // Process the data with proper date handling
            trialingData = jsonData.slice(1).map(row => {
                let processedDate = row[2];
                
                // Handle different date formats
                if (typeof processedDate === 'number') {
                    // Excel date serial number - convert to proper date
                    processedDate = XLSX.SSF.parse_date_code(processedDate);
                    processedDate = new Date(processedDate.y, processedDate.m - 1, processedDate.d);
                } else if (typeof processedDate === 'string') {
                    // String date - parse it
                    processedDate = new Date(processedDate);
                } else if (processedDate instanceof Date) {
                    // Already a date object
                    processedDate = processedDate;
                } else {
                    // Invalid date
                    processedDate = null;
                }
                
                return {
                    registrationNumber: row[0],       // Column A
                    callName: row[1],                 // Column B  
                    date: processedDate,              // Column C
                    level: row[3],                    // Column D
                    results: row[4],                  // Column E
                    judge: row[5],                    // Column F
                    points: parseFloat(row[6]) || 0   // Column G
                };
            }).filter(record => record.registrationNumber && record.level);
            
            console.log('Data processed:', trialingData.length, 'records');
        }

        function updateLastUpdatedDate() {
            if (trialingData.length === 0) {
                document.getElementById('lastUpdated').textContent = 'No data available';
                return;
            }

            // Find the most recent date in the data
            const validDates = trialingData
                .map(record => record.date)
                .filter(date => date instanceof Date && !isNaN(date))
                .sort((a, b) => b - a);

            if (validDates.length > 0) {
                const mostRecentDate = validDates[0];
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${mostRecentDate.toLocaleDateString()}`;
            } else {
                document.getElementById('lastUpdated').textContent = 'Last updated: Unknown';
            }
        }

        function formatRegistrationNumber(input) {
            if (!input) return '';
            
            // Remove any non-digits and dashes
            let cleaned = input.replace(/[^0-9-]/g, '');
            
            // If input has dashes, work with parts
            if (cleaned.includes('-')) {
                let parts = cleaned.split('-');
                if (parts.length === 3) {
                    // Format as XX-XXXX-XX with leading zeros
                    let part1 = parts[0].padStart(2, '0').substring(0, 2);
                    let part2 = parts[1].padStart(4, '0').substring(0, 4);
                    let part3 = parts[2].padStart(2, '0').substring(0, 2);
                    return `${part1}-${part2}-${part3}`;
                }
            }
            
            // If no dashes but enough digits, auto-format
            const digitsOnly = cleaned.replace(/-/g, '');
            if (digitsOnly.length >= 6) {
                const part1 = digitsOnly.substring(0, 2).padStart(2, '0');
                const part2 = digitsOnly.substring(2, 6).padStart(4, '0');
                const part3 = digitsOnly.substring(6, 8).padStart(2, '0');
                return `${part1}-${part2}-${part3}`;
            }
            
            // If partial entry, try to format what we have
            if (digitsOnly.length === 4) {
                // Assume this is the middle part (most common entry)
                return `XX-${digitsOnly}-XX`;
            }
            
            return cleaned; // Return what we have if can't format
        }

        function searchDog() {
            const searchInput = document.getElementById('searchInput').value.trim();
            if (!searchInput) {
                alert('Please enter a registration number');
                return;
            }

            if (trialingData.length === 0) {
                alert('Please wait for trialing data to load');
                return;
            }

            // Format the search input
            const formattedSearch = formatRegistrationNumber(searchInput);
            
            // Find exact matching records only
            const dogRecords = trialingData.filter(record => 
                record.registrationNumber && 
                record.registrationNumber.toLowerCase() === formattedSearch.toLowerCase()
            );

            if (dogRecords.length === 0) {
                // If no exact match, show suggestion with partial matches
                const partialMatches = trialingData.filter(record =>
                    record.registrationNumber && 
                    record.registrationNumber.toLowerCase().includes(formattedSearch.toLowerCase())
                ).slice(0, 5); // Limit to 5 suggestions

                let errorMessage = `No dog found with registration number: <strong>${formattedSearch}</strong>`;
                
                if (partialMatches.length > 0) {
                    errorMessage += '<br><br><strong>Did you mean:</strong><ul style="text-align: left; margin: 10px 0;">';
                    partialMatches.forEach(match => {
                        errorMessage += `<li><a href="#" onclick="searchSpecific('${match.registrationNumber}')" style="color: #007bff; text-decoration: underline;">${match.registrationNumber} (${match.callName || 'Unknown'})</a></li>`;
                    });
                    errorMessage += '</ul>';
                }

                document.getElementById('summaryContent').innerHTML = 
                    `<div class="error-message">${errorMessage}</div>`;
                return;
            }

            // Store records globally for modal access
            currentDogRecords = dogRecords;
            displaySummary(dogRecords);
        }

        function searchSpecific(regNumber) {
            document.getElementById('searchInput').value = regNumber;
            searchDog();
        }

        function displaySummary(records) {
            const regNumber = records[0].registrationNumber;
            
            // Get names - prioritize DogInfo.xlsx, fallback to trialing data
            const callName = getCallNameFromDogInfo(regNumber, records[0].callName) || 'Unknown';
            const handlerName = getHandlerNameFromDogInfo(regNumber);
            
            const levelSummary = {};
            
            // Group records by level
            records.forEach(record => {
                if (!record.level) return;
                
                if (!levelSummary[record.level]) {
                    levelSummary[record.level] = {
                        totalPoints: 0,
                        judges: new Set(),
                        records: []
                    };
                }
                
                if (record.points > 0) {
                    levelSummary[record.level].totalPoints += record.points;
                    if (record.judge) {
                        levelSummary[record.level].judges.add(record.judge);
                    }
                }
                levelSummary[record.level].records.push(record);
            });

            // Apply validation rules
            const validatedLevels = applyValidationRules(levelSummary);

            let html = `
                <div class="dog-info">
                    ${handlerName ? `<p class="handler-name"><strong>Handler:</strong> ${handlerName}</p>` : ''}
                    <h3>${callName}</h3>
                    <p><strong>Registration:</strong> ${regNumber}</p>
                    <p><strong>Total Trialing Records:</strong> ${records.length}</p>
                </div>
            `;
            
            getSortedLevels(levelSummary).forEach(level => {
                const summary = levelSummary[level];
                const isValidated = validatedLevels[level];
                const judgeCount = summary.judges.size;
                
                const hasTitleRequirements = summary.totalPoints >= 4 && judgeCount >= 2 && isValidated;
                
                // For Games levels, also check if they have enough different games
                let gamesInfo = '';
                if (level.startsWith('Games ')) {
                    const uniqueGames = getUniqueGames(summary.records);
                    gamesInfo = `<div><span>Different Games:</span> <strong>${uniqueGames.size}/2</strong> (${Array.from(uniqueGames).join(', ') || 'None'})</div>`;
                }
                
                // Calculate title points and ace points
                let titlePoints = 0;
                let acePoints = 0;
                let titleStatus = '';
                let titleClass = '';
                let titleInfo = null;
                
                if (hasTitleRequirements) {
                    // Find the point at which title was earned (when both 4 points and 2 judges were achieved)
                    titleInfo = calculateTitlePoints(summary.records);
                    titlePoints = titleInfo.titlePoints;
                    const titleDate = titleInfo.titleDate;
                    acePoints = Math.max(0, summary.totalPoints - titlePoints);
                    
                    const officialTitle = titleAbbreviations[level] || level;
                    
                    if (acePoints >= 10) {
                        const aceCount = Math.floor(acePoints / 10);
                        if (aceCount === 1) {
                            titleStatus = `${officialTitle}A`;
                        } else {
                            titleStatus = `${officialTitle}Ax${aceCount}`;
                        }
                        titleClass = 'title-earned';
                    } else {
                        titleStatus = `${officialTitle} Title Earned`;
                        titleClass = 'title-earned';
                    }
                } else {
                    titleStatus = 'No Title Yet';
                    titleClass = 'no-title';
                }

                // Generate certificate buttons
                let certificateButtons = '';
                if (hasTitleRequirements) {
                    const officialTitle = titleAbbreviations[level] || level;
                    const escapedLevel = escapeJs(level);
                    const escapedRegNumber = escapeJs(regNumber);
                    const escapedOfficialTitle = escapeJs(officialTitle);
                    
                    // Title certificate button
                    certificateButtons += `
                        <button class="certificate-btn" onclick="generateTitleCertificate('${escapedLevel}', '${escapedRegNumber}', '${escapedOfficialTitle}')">
                            📜 Title Certificate
                        </button>
                    `;
                    
                    // Ace certificate button (if applicable)
                    if (acePoints >= 10) {
                        const aceCount = Math.floor(acePoints / 10);
                        certificateButtons += `
                            <button class="certificate-btn" onclick="generateAceCertificate('${escapedLevel}', '${escapedRegNumber}', ${aceCount})">
                                🏆 Ace Certificate
                            </button>
                        `;
                    }
                }
                
                html += `
                    <div class="level-summary">
                        <div class="level-info">
                            <h4>${level}</h4>
                            <div class="title-status ${titleClass}">${titleStatus}</div>
                            
                            <div class="points-breakdown">
                                <div><span>Total Points:</span> <strong>${summary.totalPoints}</strong></div>
                                <div><span>Judges:</span> <strong>${judgeCount}/2</strong></div>
                                ${gamesInfo}
                                ${hasTitleRequirements ? `
                                    <div><span>Points Towards Title:</span> <strong>${titlePoints}</strong></div>
                                    <div><span>Points Towards Ace:</span> <strong class="ace-info">${acePoints}</strong></div>
                                    ${titleInfo && titleInfo.titleDate ? `<div style="color: #28a745; font-size: 0.85rem;"><span>Title Earned:</span> <strong>${titleInfo.titleDate instanceof Date && !isNaN(titleInfo.titleDate) ? titleInfo.titleDate.toLocaleDateString() : 'N/A'}</strong></div>` : ''}
                                    ${(() => {
                                        const aceEarnedDates = findAceEarnedDates(summary.records, titlePoints);
                                        if (aceEarnedDates.length > 0) {
                                            const latestAce = aceEarnedDates[aceEarnedDates.length - 1];
                                            const aceDate = latestAce.date instanceof Date && !isNaN(latestAce.date) ? latestAce.date.toLocaleDateString() : 'N/A';
                                            return `<div style="color: #6f42c1; font-size: 0.85rem;"><span>Latest Ace Earned:</span> <strong>${aceDate}</strong></div>`;
                                        }
                                        return '';
                                    })()}
                                    ${acePoints < 10 && acePoints >= 0 ? `<div class="ace-info"><span>Points until next Ace:</span> <strong>${10 - (acePoints % 10)}</strong></div>` : 
                                    acePoints >= 10 ? `<div class="ace-info"><span>Points until next Ace:</span> <strong>${10 - (acePoints % 10)}</strong></div>` : ''}
                                ` : `
                                    <div style="color: #dc3545;">
                                        <div><span>Need:</span> ${summary.totalPoints < 4 ? `${4 - summary.totalPoints} more points` : ''}
                                        ${summary.totalPoints < 4 && judgeCount < 2 ? ', ' : ''}
                                        ${judgeCount < 2 ? `${2 - judgeCount} more judge${judgeCount === 0 ? 's' : ''}` : ''}
                                        ${level.startsWith('Games ') && getUniqueGames(summary.records).size < 2 ? 
                                            `${(summary.totalPoints < 4 || judgeCount < 2) ? ', ' : ''}${2 - getUniqueGames(summary.records).size} more different game${getUniqueGames(summary.records).size === 0 ? 's' : ''}` : ''}</div>
                                        ${!isValidated && !level.startsWith('Games ') ? `<div><span>Prerequisites:</span> ${getPrerequisiteText(level)}</div>` : ''}
                                    </div>
                                `}
                            </div>
                        </div>
                        <div class="certificate-controls">
                            <button class="details-btn" onclick="showLevelDetails('${escapeJs(level)}', '${escapeJs(callName)}')">Details</button>
                            ${certificateButtons}
                        </div>
                    </div>
                `;
            });

            document.getElementById('summaryContent').innerHTML = html || '<div class="error-message">No level data to display</div>';
        }

        function calculateTitlePoints(records) {
            // Sort records chronologically
            const sortedRecords = records
                .filter(r => r.points > 0 && r.date instanceof Date && !isNaN(r.date))
                .sort((a, b) => a.date - b.date);
            
            let cumulativePoints = 0;
            let judges = new Set();
            
            for (const record of sortedRecords) {
                const prevPoints = cumulativePoints;
                const prevJudgeCount = judges.size;
                
                cumulativePoints += record.points;
                if (record.judge) judges.add(record.judge);
                
                // Check if title requirements are NOW met (but weren't before)
                const nowHasTitle = cumulativePoints >= 4 && judges.size >= 2;
                const previouslyHadTitle = prevPoints >= 4 && prevJudgeCount >= 2;
                
                if (nowHasTitle && !previouslyHadTitle) {
                    // Title was just earned with this record
                    // Calculate how many points from this record went to earning the title
                    let pointsTowardTitle = record.points;
                    
                    // If we already had 4+ points but needed another judge
                    if (prevPoints >= 4 && prevJudgeCount < 2) {
                        // Only 1 point goes to title (to satisfy the minimum), rest goes to ace
                        pointsTowardTitle = 1;
                    }
                    // If we had 2+ judges but needed more points
                    else if (prevJudgeCount >= 2 && prevPoints < 4) {
                        // Only enough points to reach 4 go to title
                        pointsTowardTitle = 4 - prevPoints;
                    }
                    // If we needed both conditions
                    else if (prevPoints < 4 && prevJudgeCount < 2) {
                        // Enough points to reach 4, or all the points if less than needed
                        pointsTowardTitle = Math.min(record.points, 4 - prevPoints);
                    }
                    
                    return {
                        titlePoints: prevPoints + pointsTowardTitle,
                        titleDate: record.date
                    };
                }
            }
            
            // If we get here, either no title was earned, or all points go to title
            return {
                titlePoints: cumulativePoints,
                titleDate: sortedRecords[sortedRecords.length - 1]?.date
            };
        }

        function findAceEarnedDates(records, titlePoints) {
            const sortedRecords = records
                .filter(r => r.points > 0 && r.date instanceof Date && !isNaN(r.date))
                .sort((a, b) => a.date - b.date);
            
            let cumulativePoints = 0;
            const aceEarnedDates = [];
            
            for (const record of sortedRecords) {
                const prevPoints = cumulativePoints;
                cumulativePoints += record.points;
                
                // Check for ace milestones after title was earned
                if (prevPoints >= titlePoints && cumulativePoints > titlePoints) {
                    const prevAcePoints = prevPoints - titlePoints;
                    const newAcePoints = cumulativePoints - titlePoints;
                    
                    const prevAceCount = Math.floor(prevAcePoints / 10);
                    const newAceCount = Math.floor(newAcePoints / 10);
                    
                    // If ace count increased, record when each ace was earned
                    for (let i = prevAceCount + 1; i <= newAceCount; i++) {
                        aceEarnedDates.push({
                            aceNumber: i,
                            date: record.date
                        });
                    }
                }
            }
            
            return aceEarnedDates;
        }

        function applyValidationRules(levelSummary) {
            const validatedLevels = {};
            
            // First, mark all levels without prerequisites as valid (but check Games separately)
            Object.keys(levelSummary).forEach(level => {
                if (!prerequisites[level] && !level.startsWith('Games ')) {
                    validatedLevels[level] = true;
                }
            });

            // Handle Games levels specially - they need 2+ different games
            Object.keys(levelSummary).forEach(level => {
                if (level.startsWith('Games ')) {
                    const summary = levelSummary[level];
                    const uniqueGames = getUniqueGames(summary.records);
                    const hasEnoughGames = uniqueGames.size >= 2;
                    const hasBasicRequirements = summary.totalPoints >= 4 && summary.judges.size >= 2;
                    validatedLevels[level] = hasEnoughGames && hasBasicRequirements;
                }
            });

            // Then validate levels with prerequisites
            Object.keys(prerequisites).forEach(level => {
                if (!levelSummary[level]) {
                    validatedLevels[level] = false;
                    return;
                }

                let meetsPrereqCriteria = false;

                if (level === "Investigator 3") {
                    // Special case: requires either Patrol 1 OR Detective 2
                    const patrol1Valid = checkLevelRequirements(levelSummary["Patrol 1"]);
                    const detective2Valid = checkLevelRequirements(levelSummary["Detective 2"]);
                    meetsPrereqCriteria = patrol1Valid || detective2Valid;
                } else {
                    // Standard case: check direct prerequisite
                    const prereqLevel = prerequisites[level][0];
                    meetsPrereqCriteria = checkLevelRequirements(levelSummary[prereqLevel]);
                }

                validatedLevels[level] = meetsPrereqCriteria;
            });

            return validatedLevels;
        }

        function getUniqueGames(records) {
            const games = new Set();
            const gamesList = ['BJ', 'C', 'P', 'T', 'GB'];
            
            records.forEach(record => {
                if (record.results) {
                    const results = record.results.toString().toUpperCase();
                    gamesList.forEach(game => {
                        if (results.includes(game)) {
                            games.add(game);
                        }
                    });
                }
            });
            
            return games;
        }

        function checkLevelRequirements(levelData) {
            if (!levelData) return false;
            return levelData.totalPoints >= 4 && levelData.judges.size >= 2;
        }

        function getPrerequisiteText(level) {
            if (!prerequisites[level]) return 'None';
            
            if (level === "Investigator 3") {
                return 'Either "Patrol 1" OR "Detective 2" (4+ points, 2+ judges each)';
            }
            
            return `"${prerequisites[level][0]}" (4+ points, 2+ judges)`;
        }

        function showLevelDetails(level, dogName) {
            const records = currentDogRecords.filter(r => r.level === level);
            
            document.getElementById('modalTitle').textContent = `${dogName} - ${level} Details`;
            
            let html = `
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Judge</th>
                            <th>Results</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            records.sort((a, b) => new Date(a.date) - new Date(b.date));

            records.forEach(record => {
                const date = record.date && record.date instanceof Date && !isNaN(record.date) 
                    ? record.date.toLocaleDateString() 
                    : 'N/A';
                const pointsClass = record.points > 0 ? 'points-badge' : 'points-badge zero';
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${record.judge || 'N/A'}</td>
                        <td>${record.results || 'N/A'}</td>
                        <td><span class="${pointsClass}">${record.points}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Initialize - simplified and more robust
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 CWAGS Tracker initializing...');
            document.getElementById('lastUpdated').textContent = 'Loading data...';
            
            // Check fontkit after a delay
            setTimeout(() => {
                if (typeof fontkit !== 'undefined') {
                    console.log('✅ Fontkit library loaded successfully');
                } else {
                    console.warn('⚠️ Fontkit library failed to load - custom fonts will not work');
                }
            }, 1000);
            
            // Load files with proper sequencing and error handling
            setTimeout(async () => {
                try {
                    console.log('📊 Step 1: Loading DogInfo data...');
                    const dogInfoLoaded = await loadDogInfoData();
                    
                    if (dogInfoLoaded) {
                        console.log('✅ Step 1 complete: DogInfo data ready');
                    } else {
                        console.log('⚠️ Step 1 skipped: DogInfo not available');
                    }

                    console.log('📊 Step 2: Loading Title Placement data...');
                    const titlePlacementLoaded = await loadTitlePlacementData();
                    
                    if (titlePlacementLoaded) {
                        console.log('✅ Step 2 complete: Title Placement data ready');
                    } else {
                        console.log('⚠️ Step 2 skipped: Title Placement not available');
                    }
                    
                    console.log('📁 Step 3: Loading main trialing data...');
                    loadDataFromFile();
                    
                } catch (error) {
                    console.error('❌ Initialization error:', error);
                    document.getElementById('lastUpdated').textContent = 'Initialization failed';
                    showFileUpload();
                }
            }, 500); // Increased delay to prevent loading loop
        });

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
